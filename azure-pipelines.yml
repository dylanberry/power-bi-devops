parameters:
- name: EnvironmentName
  displayName: Environment Name
  type: string
- name: EnvironmentType
  displayName: Environment Type
  type: string
- name: ServiceConnection
  displayName: Service Connection
  type: string
  default: SL ESS PROD - IACTest

trigger: none

pool:
  vmImage: windows-latest

variables:
  location: 'CanadaCentral'
  backendResourceGroupName: 'TerraForm'
  backendStorageAccountName: 'TFStatePbiDevOps'
  backendStorageAccountContainerName: 'TerraFormState'
  vmResourceGroupName: 'PbiDevOps'

steps:
- task: TerraformInstaller@0
  inputs:
    terraformVersion: 'latest'

- task: AzureCLI@2
  inputs:
    azureSubscription: 'Visual Studio Enterprise with MSDN(892f38d0-c75b-4c0f-aeee-4d550baea221)'
    scriptType: 'pscore'
    scriptLocation: 'scriptPath'
    scriptPath: 'Create-PowerBIPipelineAgents.ps1'
    arguments: '-AzdoUri "$(System.TeamFoundationCollectionUri)" -Location "$(location)" -BackendResourceGroupName "$(backendResourceGroupName)" -BackendStorageAccountName "$(backendStorageAccountName)" -BackendStorageContainerName "$(backendStorageAccountContainerName)" -VmResourceGroupName "$(vmResourceGroupName)"'
    failOnStandardError: true
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)